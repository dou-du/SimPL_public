var atom_params={};
atom_params['H']={radius : 0.79, color : '0xFFD3D3', mass : 1.00794};
atom_params['He']={radius : 0.49, color : '0xFE1E00', mass : 4.002602};
atom_params['Li']={radius : 1.05, color : '0xf477ff', mass : 6.941};
atom_params['Be']={radius : 1.4, color : '0x003EFE', mass : 9.012182};
atom_params['B']={radius : 1.17, color : '0xBFFE00', mass : 10.811};
atom_params['C']={radius : 0.91, color : '0x999999', mass : 12.0107};
atom_params['N']={radius : 0.75, color : '0x6D77FF', mass : 14.00674};
atom_params['O']={radius : 0.65, color : '0xFF0000', mass : 15.9994};
atom_params['F']={radius : 0.57, color : '0x6DFF89', mass : 18.9984032};
atom_params['Ne']={radius : 0.51, color : '0xFE1900', mass : 20.1797};
atom_params['Na']={radius : 2.23, color : '0x0009FE', mass : 22.98976928};
atom_params['Mg']={radius : 1.72, color : '0x0043FE', mass : 24.305};
atom_params['Al']={radius : 1.82, color : '0xC5FE00', mass : 26.9815386};
atom_params['Si']={radius : 1.46, color : '0xFEFC00', mass : 28.0855};
atom_params['P']={radius : 1.23, color : '0xFF6666', mass : 30.973762};
atom_params['S']={radius : 1.09, color : '0xFFFF00', mass : 32.066};
atom_params['Cl']={radius : 0.97, color : '0xFE4E00', mass : 35.4527};
atom_params['Ar']={radius : 0.88, color : '0xFE1400', mass : 39.948};
atom_params['K']={radius : 2.77, color : '0x000EFE', mass : 39.0983};
atom_params['Ca']={radius : 2.23, color : '0x0048FE', mass : 40.078};
atom_params['Sc']={radius : 2.09, color : '0x0083FE', mass : 44.955912};
atom_params['Ti']={radius : 2, color : '0x00BDFE', mass : 47.867};
atom_params['V']={radius : 1.92, color : '0x00F7FE', mass : 50.9415};
atom_params['Cr']={radius : 1.85, color : '0x00FECA', mass : 51.9961};
atom_params['Mn']={radius : 1.79, color : '0x9C7AC7', mass : 54.938045};
atom_params['Fe']={radius : 1.72, color : '0x00FE56', mass : 55.845};
atom_params['Co']={radius : 1.67, color : '0x00FE1C', mass : 58.933195};
atom_params['Ni']={radius : 1.62, color : '0x1CFE00', mass : 58.6934};
atom_params['Cu']={radius : 1.57, color : '0x8C3610', mass : 63.546};
atom_params['Zn']={radius : 1.53, color : '0x90FE00', mass : 65.39};
atom_params['Ga']={radius : 1.81, color : '0xCAFE00', mass : 69.723};
atom_params['Ge']={radius : 1.52, color : '0xFEF700', mass : 72.61};
atom_params['As']={radius : 1.33, color : '0xFEBD00', mass : 74.9216};
atom_params['Se']={radius : 1.22, color : '0xFE8300', mass : 78.96};
atom_params['Br']={radius : 1.12, color : '0xFE4800', mass : 79.904};
atom_params['Kr']={radius : 1.03, color : '0xFE0E00', mass : 83.8};
atom_params['Rb']={radius : 2.98, color : '0x0014FE', mass : 85.4678};
atom_params['Sr']={radius : 2.45, color : '0x004EFE', mass : 87.62};
atom_params['Y']={radius : 2.27, color : '0x0088FE', mass : 88.90585};
atom_params['Zr']={radius : 2.16, color : '0x00C2FE', mass : 91.224};
atom_params['Nb']={radius : 2.08, color : '0x00FCFE', mass : 92.90638};
atom_params['Mo']={radius : 2.01, color : '0x64BDB0', mass : 95.94};
atom_params['Tc']={radius : 1.95, color : '0x00FE8B', mass : 97.9072};
atom_params['Ru']={radius : 1.89, color : '0x00FE50', mass : 101.07};
atom_params['Rh']={radius : 1.83, color : '0x00FE16', mass : 102.9055};
atom_params['Pd']={radius : 1.79, color : '0x21FE00', mass : 106.42};
atom_params['Ag']={radius : 1.75, color : '0x464646', mass : 107.8682};
atom_params['Cd']={radius : 1.71, color : '0x95FE00', mass : 112.411};
atom_params['In']={radius : 2, color : '0xCFFE00', mass : 114.818};
atom_params['Sn']={radius : 1.72, color : '0xFEF200', mass : 118.71};
atom_params['Sb']={radius : 1.53, color : '0xFEB700', mass : 121.76};
atom_params['Te']={radius : 1.42, color : '0xFE7D00', mass : 127.6};
atom_params['I']={radius : 1.32, color : '0xFE4300', mass : 126.90447};
atom_params['Xe']={radius : 1.24, color : '0xFE0900', mass : 131.29};
atom_params['Cs']={radius : 3.34, color : '0x0019FE', mass : 132.9054519};
atom_params['Ba']={radius : 2.78, color : '0x585017', mass : 137.327};
atom_params['La']={radius : 2.74, color : '0x008DFE', mass : 178.49};
atom_params['Ce']={radius : 2.7, color : '0x008DFE', mass : 180.94788};
atom_params['Pr']={radius : 2.67, color : '0x008DFE', mass : 183.84};
atom_params['Nd']={radius : 2.64, color : '0x008DFE', mass : 186.207};
atom_params['Pm']={radius : 2.62, color : '0x008DFE', mass : 190.23};
atom_params['Sm']={radius : 2.59, color : '0x008DFE', mass : 192.217};
atom_params['Eu']={radius : 2.56, color : '0x008DFE', mass : 195.084};
atom_params['Gd']={radius : 2.54, color : '0x008DFE', mass : 196.966569};
atom_params['Tb']={radius : 2.51, color : '0x008DFE', mass : 200.59};
atom_params['Dy']={radius : 2.49, color : '0x008DFE', mass : 204.3833};
atom_params['Ho']={radius : 2.47, color : '0x008DFE', mass : 207.2};
atom_params['Er']={radius : 2.45, color : '0x008DFE', mass : 208.9804};
atom_params['Tm']={radius : 2.42, color : '0x008DFE', mass : 208.9824};
atom_params['Yb']={radius : 2.4, color : '0x008DFE', mass : 209.9871};
atom_params['Lu']={radius : 2.25, color : '0x008DFE', mass : 222.0176};
atom_params['Hf']={radius : 2.16, color : '0x00C7FE', mass : 138.90547};
atom_params['Ta']={radius : 2.09, color : '0x00FEFA', mass : 140.116};
atom_params['W']={radius : 2.02, color : '0x00FEBF', mass : 140.90765};
atom_params['Re']={radius : 1.97, color : '0x00FE85', mass : 144.242};
atom_params['Os']={radius : 1.92, color : '0x00FE4B', mass : 144.9127};
atom_params['Ir']={radius : 1.87, color : '0x00FE11', mass : 150.36};
atom_params['Pt']={radius : 1.83, color : '0x26FE00', mass : 151.964};
atom_params['Au']={radius : 1.79, color : '0x585017', mass : 157.25};
atom_params['Hg']={radius : 1.76, color : '0x9AFE00', mass : 158.92535};
atom_params['Tl']={radius : 2.08, color : '0xD5FE00', mass : 162.5};
atom_params['Pb']={radius : 1.81, color : '0xFEEC00', mass : 164.93032};
atom_params['Bi']={radius : 1.63, color : '0xFEB200', mass : 167.259};
atom_params['Po']={radius : 1.53, color : '0xFE7800', mass : 168.93421};
atom_params['At']={radius : 1.43, color : '0xFE3E00', mass : 173.04};
atom_params['Rn']={radius : 1.34, color : '0xFE0400', mass : 174.967};
atom_params['Fr']={radius : 1.5, color : '0x001EFE', mass : 223.0197};
atom_params['Ra']={radius : 1.5, color : '0x0058FE', mass : 226.0254};
atom_params['Ac']={radius : 1.88, color : '0x0092FE', mass : 263.1125};
atom_params['Th']={radius : 1.5, color : '0x0092FE', mass : 262.1144};
atom_params['Pa']={radius : 1.5, color : '0x0092FE', mass : 266.1219};
atom_params['U']={radius : 1.5, color : '0x0092FE', mass : 264.1247};
atom_params['Np']={radius : 1.5, color : '0x0092FE', mass : 269.1341};
atom_params['Pu']={radius : 1.5, color : '0x0092FE', mass : 268.1388};
atom_params['Am']={radius : 1.5, color : '0x0092FE', mass : 272.1463};
atom_params['Cm']={radius : 1.5, color : '0x0092FE', mass : 272.1535};
atom_params['Bk']={radius : 1.5, color : '0x0092FE', mass : 277};
atom_params['Cf']={radius : 1.5, color : '0x0092FE', mass : 284};
atom_params['Es']={radius : 1.5, color : '0x0092FE', mass : 289};
var Structure={};;
getmybin = function(x,y,z)
    {
		var nbin_x = Structure.bindim[0];
		var nbin_y = Structure.bindim[1];
		var nbin_z = Structure.bindim[2];
        var myx=Math.floor(x/Structure.binsize);
        var myy=Math.floor(y/Structure.binsize);
        var myz=Math.floor(z/Structure.binsize);
            if(myx<0) myx = nbin_x+myx;
            if(myy<0) myy = nbin_y+myy;
            if(myz<0) myz = nbin_z+myz;
            if(myx==nbin_x) myx--;
            if(myy==nbin_y) myy--;
            if(myz==nbin_z) myz--;

        return Array(myx,myy,myz);
    }
function fractocart(vector,cell){
	return vecmulmat(vector,cell)
}
function rand3(){
	return [Math.random(), Math.random(), Math.random()];
}
random3 = function(dx,dy,dz,padding)
{
	var rx,ry,rz;
		rx=0.5*padding+Math.random()*(dx-padding);
		ry=0.5*padding+Math.random()*(dy-padding);
		rz=0.5*padding+Math.random()*(dz-padding);
	return {"x":rx,"y":ry,"z":rz};
}

check_bin_next_bin = function(bin1,bin2,tol)
{
	var bin_dx,bin_dy,bin_dz;
	bin_dx=bin2[0]-bin1[0];
	if(bin_dx>tol||-bin_dx>tol) return false;
	bin_dy=bin2[1]-bin1[1];
	if(bin_dy>tol||-bin_dy>tol) return false;
	bin_dz=bin2[2]-bin1[2];
	if(bin_dz>tol||-bin_dz>tol) return false;
return true;
}
bindist = function(bin1,bin2){
	var bindim=Structure.bindim;
	bin_dx=Math.abs(bin2[0]-bin1[0]);
	bin_dy=Math.abs(bin2[1]-bin1[1]);
	bin_dz=Math.abs(bin2[2]-bin1[2]);
	return bin_dx<bin_dy?(bin_dx<bin_dz?bin_dx:bin_dz):(bin_dy<bin_dz?bin_dy:bin_dz);
}

get_atoms_in_nearest_bins = function( myx, myy, myz){
	var bindim=Structure.bindim;
	var bins=Structure.bin;
	var x_start=myx-1<0?0:myx-1;
	var y_start=myy-1<0?0:myy-1;
	var z_start=myz-1<0?0:myz-1;
	var x_end=myx+1>bindim[0]?bindim[0]:myx+1;
	var y_end=myy+1>bindim[1]?bindim[1]:myy+1;
	var z_end=myz+1>bindim[2]?bindim[2]:myz+1;
	var ret=[];
	for(var i=x_start;i<x_end;i++){
		for(var j=y_start;j<y_end;j++){
			for(var k=z_start;k<z_end;k++){
				var idx=i*bindim[1]*bindim[2]+j*bindim[2]+k;
				for(var l=0;l<bins[idx].length;l++)
				{
					ret.push(bins[idx][l]);
				}
			}
		}
	}
	return ret;
}
//
getVectorLength = function(v1)
{
	var len = 0;
	for(var i=0;i<v1.length;i++)
	{
		len+= v1[i]*v1[i];
	}
	return Math.sqrt(len);
}
//
updatebin = function(){
	Structure.bin=[];
	var latMat = [Structure.a, Structure.b, Structure.c];
    var xmax,xmin,ymax,ymin,zmax,zmin;
    var refPos = [[0,0,0],[1,0,0],[0,1,0],[0,0,1],[1,1,0],[0,1,1],[1,0,1],[1,1,1]];
    for(var i=0;i<8;i++){
        var tmpPos=refPos[i];
        var atomPos_tmp = vecmulmat(  tmpPos, latMat );
        if(xmax===undefined){
            xmax=atomPos_tmp[0];
            xmin=atomPos_tmp[0];

            ymax=atomPos_tmp[1];
            ymin=atomPos_tmp[1];

            zmax=atomPos_tmp[2];
            zmin=atomPos_tmp[2];
        }
        if(atomPos_tmp[0]<xmin) xmin=atomPos_tmp[0];
        if(atomPos_tmp[1]<ymin) ymin=atomPos_tmp[1];
        if(atomPos_tmp[2]<zmin) zmin=atomPos_tmp[2];

        if(atomPos_tmp[0]>xmax) xmax=atomPos_tmp[0];
        if(atomPos_tmp[1]>ymax) ymax=atomPos_tmp[1];
        if(atomPos_tmp[2]>zmax) zmax=atomPos_tmp[2];
    }
	Structure.binsize=3; //  size of bin
	var bs = Structure.binsize;
    var nbin_x = Math.floor((xmax - xmin)/bs);
    var nbin_y = Math.floor((ymax - ymin)/bs);
    var nbin_z = Math.floor((zmax - zmin)/bs);


	//return;
/*	var nbin_x=Math.floor(getVectorLength(Structure.a)/Structure.binsize);
	var nbin_y=Math.floor(getVectorLength(Structure.b)/Structure.binsize);
	var nbin_z=Math.floor(getVectorLength(Structure.c)/Structure.binsize);*/
	if(nbin_x==0) nbin_x=1;
	if(nbin_y==0) nbin_y=1;
	if(nbin_z==0) nbin_z=1;

	for(var i=0;i<nbin_x*nbin_y*nbin_z;i++) Structure.bin[i]=[];
	for(var i=0;i<Structure.atoms.length;i++)
	{
		var myx=Math.floor(Structure.atoms[i].x/Structure.binsize);
		var myy=Math.floor(Structure.atoms[i].y/Structure.binsize);
		var myz=Math.floor(Structure.atoms[i].z/Structure.binsize);
			

            if(myx<0) myx = nbin_x+myx;
            if(myy<0) myy = nbin_y+myy;
            if(myz<0) myz = nbin_z+myz;
            if(myx==nbin_x) myx--;
            if(myy==nbin_y) myy--;
            if(myz==nbin_z) myz--;


		var binidx=myx*nbin_y*nbin_z+myy*nbin_z+myz;
		try{
			Structure.bin[binidx].push(i);
		}catch(e)
		{
			console.log(binidx);
		}
		Structure.atoms[i].bin=[myx,myy,myz];
	}
	Structure.bindim=[nbin_x,nbin_y,nbin_z];
}
function calc_dr(x1,y1,z1,x2,y2,z2)
{
	var dx=x1-x2;
	var dy=y1-y2;
	var dz=z1-z2;
	return Math.sqrt(dx*dx+dy*dy+dz*dz);
}
function max3(a,b,c)
{
	if(a>b)
	{
		if(a>=c) return a;
		if(c>=a) return c;
	}else{
		if(b>=c) return b;
		if(c>=b) return c;
	}	
}
function getmolarmass(mol)
{
	var ret=0;
	for(var i=0;i<mol.atom.length;i++)
	{
		ret+=atom_params[mol.atom[i].element]*1;
	}
	return ret;
}
function vecmulmat(vec,mat){
		var ret = [0,0,0];
		for(var i=0;i<3;i++){
			for(var j=0;j<3;j++){
				ret[i]+=vec[j]*mat[j][i];
			}
		}
		return ret;
}
function matmulvec(mat,vec)
    {
        var ret=[0,0,0];

        for(var i=0;i<3;i++)
        {
            for(var j=0;j<3;j++)
            {
                ret[i]+=mat[i][j]*vec[j];
            }
        }
        return ret;
    }

function rotate3d(dir,pos,angle)
{
    var cos=Math.cos(angle/180*Math.PI);
    var sin=Math.sin(angle/180*Math.PI);
    var mat=Array(3);
    switch(dir){
        case "x":
            mat[0]=[1,0,0];
            mat[1]=[0,cos,-1*sin];
            mat[2]=[0,sin,cos];
        break;
        case "y":
            mat[0]=[cos,0,sin];
            mat[1]=[0,1,0];
            mat[2]=[-1*sin,0,cos];
        break;
        case "z":
            mat[0]=[cos,-1*sin,0];
            mat[1]=[sin,cos,0];
            mat[2]=[0,0,1];
        break;
    }
    return matmulvec(mat,pos);
}
getneighschild = function(binarr){
	// 占쎈Ŋ�꾬옙占� bin id([x,y,z])占쎈Ŋ苑� 占쎈챷�� bin占쏙옙 占썬끉堉깍옙�덈뮉 占쎈Ŋ�꾤뵳��わ옙占� �곗뮆��
	var nbin_x = Structure.bindim[0];
	var nbin_y = Structure.bindim[1];
	var nbin_z = Structure.bindim[2];
	var xlist,ylist,zlist;
		xlist=[];
		ylist=[];
		zlist=[];
		xlist.push(binarr[0]);
		ylist.push(binarr[1]);
		zlist.push(binarr[2]);
		if(binarr[0]-1>=0){ xlist.push(binarr[0]-1);}else{  xlist.push(Structure.bindim[0]-1);}
		if(binarr[1]-1>=0){ ylist.push(binarr[1]-1);}else{  ylist.push(Structure.bindim[1]-1);}
		if(binarr[2]-1>=0){ zlist.push(binarr[2]-1);}else{  zlist.push(Structure.bindim[2]-1);}
		if(binarr[0]+1<nbin_x){ xlist.push(binarr[0]+1);}else{  xlist.push(0);}
		if(binarr[1]+1<nbin_y){ ylist.push(binarr[1]+1);}else{  ylist.push(0);}
		if(binarr[2]+1<nbin_z){ zlist.push(binarr[2]+1);}else{  zlist.push(0);}
	var retarr=[];
	
	var i,j,k;
	for(var ii=0;ii<xlist.length;ii++){
		for(var jj=0;jj<ylist.length;jj++){
			for(var kk=0;kk<zlist.length;kk++){
				i=xlist[ii];
				j=ylist[jj];
				k=zlist[kk];
				var binidx=i*nbin_y*nbin_z+j*nbin_z+k;
				if(Structure.bin[binidx]===undefined){console.log(i,j,k,binidx);}

				for(var ll=0;ll<Structure.bin[binidx].length;ll++)
				{
					if(!findelementinarray(Structure.bin[binidx][ll],retarr))	retarr.push(Structure.bin[binidx][ll]);
				}
			}
		}
	}
	return retarr;

}
inv3 = function(m1){
    var oa = m1[0][0];
    var ob = m1[0][1];
    var oc = m1[0][2];
    var od = m1[1][0];
    var oe = m1[1][1];
    var of = m1[1][2];
    var og = m1[2][0];
    var oh = m1[2][1];
    var oi = m1[2][2];
    var oD = (oa*oe*oi+ob*of*og+oc*od*oh-oc*oe*og-ob*od*oi-oa*of*oh);
    var ret = [
                [(oe*oi-of*oh)/oD,        (-(ob*oi-oc*oh))/oD,    (ob*of-oc*oe)/oD],
                [(-(od*oi-of*og))/oD,    (oa*oi-oc*og)/oD,        (-(oa*of-oc*od))/oD],
                [(od*oh-oe*og)/oD,        (-(oa*oh-ob*og))/oD,    (oa*oe-ob*od)/oD]
              ];
    return ret;
}

function findelementinarray(el,arr)
{
/*
 *  Find elemenet in array.
 *  return true if the element is exists, otherwise return false.
 */
    for(var i=0;i<arr.length;i++)
    {
        if(el===arr[i]) return true;
    }
    return false;
}
function getvdwvol(Structure)
{
	
	var resol = 0.2;
	var atoms = Structure.atoms;
	var grid = [];
	
	var nx = Math.ceil(Structure.a[0]/resol);
	var ny = Math.ceil(Structure.b[1]/resol);
	var nz = Math.ceil(Structure.c[2]/resol);

	var _x,_y,_z;
	function getgrididx(x,y,z)
	{
		var gx = Math.floor(x/resol);
		var gy = Math.floor(y/resol);
		var gz = Math.floor(z/resol)
		return gx*ny*nz+gy*nz+gz;
	}
	for(var i=0;i<nx*ny*nz;i++)
	{
		grid[i]=0;
	}	
	console.log(nx,ny,nz);
	for(var i=0;i<atoms.length;i++)
	{
		var ca = atoms[i];
		var myrad = atom_params[ca.element].radius;

		for(var xx=ca.x-myrad;xx<ca.x+myrad;xx+=resol){
			for(var yy=ca.y-myrad;yy<ca.y+myrad;yy+=resol){
				for(var zz=ca.z-myrad;zz<ca.z+myrad;zz+=resol){
					if(calc_dr(xx,yy,zz,ca.x,ca.y,ca.z)<myrad){
						_x=xx; _y=yy;_z=zz;
						if(_x<0) _x+=Structure.a[0];	
						if(_y<0) _y+=Structure.b[1];	
						if(_z<0) _z+=Structure.c[2];	
						if(_x>Structure.a[0]) _x-=Structure.a[0];
						if(_y>Structure.b[1]) _y-=Structure.b[1];
						if(_z>Structure.c[2]) _z-=Structure.c[2];
						grid[getgrididx(_x,_y,_z)]=1;
					}
				}
			}
		}
	}
	var vol=0;
	for(var i=0;i<nx*ny*nz;i++)
	{
		vol+=grid[i];
	}
	console.log(vol);	
	return vol*resol*resol*resol;
}
function getCenterOfMass(atoms){
	var natoms = atoms.length;
	if(natoms == 0){
		return [0,0,0];
	}
	console.log(atoms);
	var cm = atoms.map( el=>[el.x,el.y,el.z] ).reduce(function(a,b){return [ a[0]+b[0], a[1]+b[1], a[2]+b[2] ]});
	return [ cm[0]/natoms, cm[1]/natoms, cm[2]/natoms ] ;
}
function vec3len(vec){
	return Math.sqrt(vec[0]*vec[0]+vec[1]*vec[1]+vec[2]*vec[2]);
}
onmessage = function(e)
{
		console.log("Q");
console.log(e);
		var largenum = 999999999;
		Structure =e.data.Structure;
		console.log(Structure);
		var molecules=e.data.molecules;
		var createcmd=e.data.createcmd;
		var maxdensity=e.data.maxdensity||largenum;
		var thickness=e.data.thickness||0;
		var angle=e.data.angle;
		var dist=e.data.dist || 0;
		var mass = 0; // total mass of box
		var rotate=e.data.rotate;
/*
		var la=Structure.a[0];
		var lb=Structure.b[1];
		var lc=Structure.c[2];
*/
		var la=vec3len(Structure.a);
		var lb=vec3len(Structure.b);
		var lc=vec3len(Structure.c);
//		var volume =  la*lb*lc; // A3
		var v_a=Structure.a.slice(0);
		var v_b=Structure.b.slice(0);
		var v_c=Structure.c.slice(0);
		var volume =  v_a[0]*(v_c[1]*v_b[2] - v_c[2]*v_b[1]) +
v_a[1]*(v_c[2]*v_b[1] - v_c[0]*v_b[2]) +
v_a[2]*(v_c[0]*v_b[1] - v_c[1]*v_b[0]);
		volume = Math.abs(volume);
		console.log("Now volume is :"+volume);
		//dist : intermolecular distance
		//var max_mols = e.data.max_mols||9999999; 
		var cutoff=0.1;
		var nadded=0;
		var rt3=1.732050;
		//var maxiter=la*lb*lc*16;
		
		var maxiter=la*lb*lc*10;
		if(angle!==undefined) maxiter*=10;
		//var maxiter=100000;
		var iter=0;
		var canbeadded;
		var newatomgroup=[];
		var tx,ty,tz;
		var density;
		var dx,dy,dz,drsq;
		var distsq=dist*dist;
		Structure.binsize=3;
		if(Structure.binsize>dist) Structure.binsize=dist;
		console.log(Structure);
		updatebin();
		var ha=[];
		var ret=[];
			ret['state']="busy";
			ret['progress']=[];
			ret['retarr']=[];
		var	retarr_tmp=[];
		var nprint=0;
		var center_mass=[0,0,0];
		var natoms_structure = Structure.atoms.length;
		var center_mass = getCenterOfMass(Structure.atoms);
		var newMolCenter_fract, newMolCenter_cart;
		var cellMatrix = [ Structure.a, Structure.b, Structure.c ];
		var cellMatrixInv = inv3(cellMatrix);
		
//		volume-=getvdwvol(Structure); 
		console.log("Initial volume is :"+volume);
		console.log("Maximum Iteration :"+maxiter);
		
		var nadded_per_mol=[];
		console.log(molecules);
// Align Atoms in each molecules to center of molecule
		var cm_mol=null, thisMol;
		for(var ii=0;ii<molecules.length;ii++){
			thisMol = molecules[ii];
			cm_mol = getCenterOfMass( thisMol.atoms );
			nadded_per_mol[ii]=0; // initialize number of added atoms in current molecule

			for(var j=0;j<thisMol.atoms.length;j++){
				var ca=thisMol.atoms[j];
				ca.x -= cm_mol[0];
				ca.y -= cm_mol[1];
				ca.z -= cm_mol[2];
			}
		}

		for(var ii=0;ii<molecules.length;ii++){
// Shift to the CM
			
			if(molecules[ii].nmols===undefined) molecules[ii].nmols=999999;
			console.log(molecules[ii].nmols);
			nadded = 0;

			for(var iter=0;iter<maxiter;iter++)
			{
				canbeadded = true;
//				newatom = random3(la,lb,lc,dist); // center of moleculms
				newMolCenter_fract = rand3();
				newMolCenter_cart = fractocart(  newMolCenter_fract, cellMatrix );
				newatom = {
					x : newMolCenter_cart[0],
					y : newMolCenter_cart[1],
					z : newMolCenter_cart[2]
				};
			//	var myneighbors=get_atoms_in_nearest_bins(tbin[0],tbin[1],tbin[2]);
			//	for(var k=0;k<myneighbors.length;k++)

					var mols_tmp = Array(); // 占쎈슣�억옙占� molecule
	
					if(rotate!==undefined){
						var r_angle_x = Math.random()*360-180;
						var r_angle_y = Math.random()*360-180;
						var r_angle_z = Math.random()*360-180;
					}
					for(var j=0;j<molecules[ii].atoms.length;j++)
					{
						var ca = molecules[ii].atoms[j];
					//  if(nadded==0) console.log(ca);
						if( !rotate ){
							tx=newatom.x+ca.x;
							ty=newatom.y+ca.y;
							tz=newatom.z+ca.z;
						}else{
							var tmp_pos = [ca.x,ca.y,ca.z];
							var r_ = rotate3d('x',tmp_pos,r_angle_x);
								r_ = rotate3d('y',r_,r_angle_y);
								r_ = rotate3d('z',r_,r_angle_z);
							tx=newatom.x+r_[0];
							ty=newatom.y+r_[1];
							tz=newatom.z+r_[2];
						}
						var tx_fract = vecmulmat( [tx,ty,tz], cellMatrixInv );
						for(var jj=0;jj<3;jj++){
							if(tx_fract[jj]<0) tx_fract[jj]+=1;
							if(tx_fract[jj]>1) tx_fract[jj]-=1;
						}
						var tx_cart = vecmulmat( tx_fract, cellMatrix );
/*						console.log(tx_fract);
						console.log(tx_cart);*/
/*						if(tx<0) tx=la+tx;
						if(ty<0) ty=lb+ty;
						if(tz<0) tz=lc+tz;

						if(tx>la) tx=tx-la;
						if(ty>lb) ty=ty-lb;
						if(tz>lc) tz=tz-lc;*/
						mols_tmp.push({x:tx_cart[0],y:tx_cart[1],z:tx_cart[2],element:ca.element});

					}
					//console.log(mols_tmp.length);
					var dontadd = false;
					var ax,ay,az,bx,by,bz,dx,dy,dz;
					for(var j=0;j<mols_tmp.length;j++){
						var ca = mols_tmp[j];
						var tmpbin = getmybin(ca.x,ca.y,ca.z);
						mols_tmp[j].bin=[tmpbin[0],tmpbin[1],tmpbin[2]];
						var myneighs = getneighschild(tmpbin);
						var r_i = atom_params[ca.element]['radius'];
						for(var kk=0;kk<myneighs.length;kk++)
						{
							var cb = Structure.atoms[myneighs[kk]];
							var r_j = atom_params[cb.element]['radius'];
							var drcut = (r_i+r_j)*1.05;
							dx = Math.abs(ca.x-cb.x); if(dx>0.5*la) dx=la-dx;
							if(dx>drcut){continue;}
							dy = Math.abs(ca.y-cb.y); if(dy>0.5*lb) dy=lb-dy;
							if(dy>drcut){continue;}
							dz = Math.abs(ca.z-cb.z); if(dz>0.5*lc) dz=lc-dz;
							if(dz>drcut){continue;}
							var dr = Math.sqrt(dx*dx+dy*dy+dz*dz);
//							if(dr<drcut||dr<dist) {dontadd=true;break;};							
							if(dr<drcut) {dontadd=true;break;};							
							
						}
						if(dontadd) break;
						
					}


					if(!dontadd){
						nadded++;
						nadded_per_mol[ii]++;
						density = mass/6.02/0.1/volume;
//						if(nadded%100==0) {console.log(nadded,density,nadded/iter);}
						if(nadded/iter<0.000001) iter=maxiter; // 1,000,000占썬끋��옙�덈툧 占쏙옙 �브쑴�꾤몴占� 筌�쑴��쭪占� 筌륁궢釉�쭖占� break
						if(density>maxdensity) iter=maxiter;
						if(iter<maxiter){
							for(var j=0;j<mols_tmp.length;j++){
    
							var ca = mols_tmp[j];
								mass+=atom_params[ca.element].mass;
							
								var myx=ca.bin[0];
								var myy=ca.bin[1];
								var myz=ca.bin[2];
								/*var nbin_x=Math.ceil(globject.poscar_json.a[0]/globject.binsize);
								var nbin_y=Math.ceil(globject.poscar_json.b[1]/globject.binsize);
								var nbin_z=Math.ceil(globject.poscar_json.c[2]/globject.binsize);
*/                      
								var nbin_x = Structure.bindim[0];
								var nbin_y = Structure.bindim[1];
								var nbin_z = Structure.bindim[2];
								var binidx=myx*nbin_y*nbin_z+myy*nbin_z+myz;
								Structure.bin[binidx].push(Structure.atoms.length);
								Structure.atoms.push({
									x:ca.x,
									y:ca.y,
									z:ca.z,
									bin:ca.bin,
									element:ca.element,
									newatom:true,
									molid:nadded,
									mol_formula:molecules[ii].formula
								});
							}
							updatebin();
						}
					}
				if(nadded>=molecules[ii].nmols){
					console.log(nadded,molecules[ii].nmols);
					console.log("target density reached");
					break;
				}
					if(iter%100==0){
						if(maxdensity == largenum){ 
							ret['progress']=[iter,maxiter];
						}else{
							ret['progress']=[density,maxdensity];
						}
						console.log(ret['progress'], nadded);
						ret['nadded_per_mol'] = nadded_per_mol;	
						postMessage(ret);
					}
				
			}
			ret['progress']=[iter,maxiter];
			ret['nadded_per_mol'] = nadded_per_mol;	
			postMessage(ret);

		}
		console.log("Current density : "+density);
		ret['state']="finished";
		ret['retarr']=Structure;
		ret['progress']=[iter,maxiter];
		postMessage(ret);
}
